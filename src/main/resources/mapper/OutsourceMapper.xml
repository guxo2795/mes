<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.wimir.bae.domain.outsource.mapper.OutsourceMapper">

    <!-- 이미 등록된 외주 확인 -->
    <select id="isExistOutsource" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, true, false) AS result
        FROM tbl_order_outsource
        WHERE is_deleted = 0
          AND product_key = #{productKey}
          AND contract_code = #{contractKey}
    </select>

    <!-- 외주 등록 -->
    <insert id="createOutsource">
        INSERT INTO tbl_order_outsource (
            contract_code, company_key, quantity,
            outbound_date_time, incoming_est_date, product_key
        )
        VALUES (
            #{contractKey}, #{companyKey}, #{quantity},
            #{outboundDateTime}, #{inboundEstDate}, #{productKey}
        )
    </insert>

    <!-- 외주 정보 조회 -->
    <select id="searchOutsourceInfo" resultType="com.wimir.bae.domain.outsource.dto.OutsourceSearchInfoDTO">
        SELECT *
        FROM tbl_order_outsource
        WHERE outsource_key = #{outsourceKey}
          AND is_deleted = 0
    </select>

    <!-- 외주 수정 -->
    <update id="updateOutsource">
        UPDATE tbl_order_outsource
        <set>
            <if test="inboundEstDate != null and inboundEstDate != ''">
                incoming_est_date = #{inboundEstDate},
            </if>
            <if test="outboundDateTime != null and outboundDateTime != ''">
                outbound_date_time = #{outboundDateTime},
            </if>
            <if test="quantity != null and quantity != ''">
                quantity = #{quantity},
            </if>
        </set>
        WHERE
        outsource_key = #{outsourceKey}
        AND is_deleted = 0
        AND outsource_state = 'P'
    </update>

    <!-- 외주 삭제 -->
    <update id="deleteOutsource">
        UPDATE tbl_order_outsource
        SET
            is_deleted = 1
        WHERE
            outsource_key = #{outsourceKey}
    </update>

    <!-- 외주 생산 제품 리스트 조회 -->
    <select id="getOutsourceItemList" resultType="com.wimir.bae.domain.outsource.dto.OutsourceItemDTO">
        SELECT
        pro.product_key,
        bom.material_key AS productCode,
        pro.product_name,
        pro.company_key,
        com.company_name,
        (cmat.quantity * bom.quantity) AS quantity,
        orout.outsource_key,
        orout.outsource_state,
        pro.standard_price,
        (pro.standard_price * cmat.quantity) AS totalPrice
        FROM tbl_order_contract con
        LEFT JOIN tbl_order_contract_materials cmat ON cmat.contract_code = con.contract_code
        LEFT JOIN tbl_product_bom bom ON cmat.product_key = bom.root_key
        LEFT JOIN tbl_product pro ON pro.product_key = bom.material_key
        LEFT JOIN tbl_company com ON com.company_key = pro.company_key
        LEFT JOIN tbl_common_code_sub sub ON pro.process_type_key = sub.sub_common_key
        LEFT JOIN tbl_order_outsource orout ON cmat.contract_code = orout.contract_code
        AND orout.product_key = bom.material_key
        WHERE cmat.contract_code = #{contractCode}
        AND sub.sub_common_key = #{processOutsourcedKey}
        AND cmat.is_deleted = 0
        AND orout.contract_code IS NULL
        AND bom.is_deleted = 0
        AND con.is_deleted = 0
        AND con.is_completed = 2
    </select>
</mapper>