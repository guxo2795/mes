<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wimir.bae.domain.planDetail.mapper.PlanDetailMapper">

    <!-- 작업지시서 등록 -->
    <insert id="createPlanDetailQuantity">
        INSERT INTO tbl_production_detail (
            plan_key,
            team_key,
            product_key,
            execute_quantity,
            sub_execute_quantity,
            fault_quantity,
            execute_date
        )
        VALUES (
             #{planKey},
             #{teamKey},
             #{productKey},
             #{executeQuantity},
             #{subExecuteQuantity},
             #{faultQuantity},
             #{executeDate}
        )
    </insert>

    <!-- 작업지시서 상세 리스트 -->
    <select id="getDetailList" resultType="com.wimir.bae.domain.planDetail.dto.DetailInfoDTO">
        SELECT
        detail_key,
        execute_date,
        execute_quantity,
        sub_execute_quantity,
        fault_quantity,
        is_completed
        FROM tbl_production_detail
        WHERE is_deleted = 0
        AND plan_key = #{planKey}
        AND product_key = #{productKey}
    </select>

    <!-- 작업지시서 상세 수정 (계획, 생산, 불량 수량) -->
    <update id="updatePlanDetailQuantity">
        UPDATE tbl_production_detail
        SET execute_quantity = #{executeQuantity},
            sub_execute_quantity = #{subExecuteQuantity},
            fault_quantity = #{faultQuantity}
        WHERE detail_key = #{detailKey}
          AND execute_date = #{executeDate}
    </update>

    <!-- 작업 지시서 삭제 -->
    <delete id="deletePlanDetail">
        UPDATE tbl_production_detail
        SET is_deleted = 1
        WHERE
            is_deleted = 0
          AND is_completed = 0
          AND detail_key = #{detailKey}
    </delete>

    <!-- 실적이 이미 등록 되어 있는지 확인 -->
    <select id="isExistDetail" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, true, false)
        FROM tbl_production_detail
        WHERE is_deleted = 0
          AND plan_key = #{planKey}
          AND execute_date = #{executeDate}
          AND product_key = #{productKey}
    </select>

    <!-- 작업지시서에 등록된 총 수량 -->
    <select id="getTotalRegisteredQuantity" resultType="string">
        SELECT COALESCE(SUM(execute_quantity), 0)
        FROM tbl_production_detail
        WHERE plan_key = #{planKey}
          AND product_key = #{productKey}
    </select>

    <!-- 생산계획서에 등록된 수주 수량 -->
    <select id="getPlanOrderedQuantity" resultType="string">
        SELECT plan_quantity
        FROM tbl_production_plan
        WHERE plan_key = #{planKey}
          AND product_key = #{productKey}
    </select>

    <!-- 확정 여부 체크 -->
    <select id="checkPlanDetailCompleted" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, true, false)
        FROM tbl_production_detail
        WHERE is_completed = 0
          AND detail_key = #{detailKey}
    </select>

</mapper>